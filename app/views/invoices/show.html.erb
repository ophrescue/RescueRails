<div class="container">
  <div class="row">
    <div class="col-12 pt-3">
      <h1>OPH Adoption Fee Payment</h1>


      <h5>Adopter <%= link_to @invoice.invoiceable.adopter.name, @invoice.invoiceable.adopter %>  </h5>

      <h5>For the Adoption of <%= link_to @invoice.invoiceable.animal.name, @invoice.invoiceable.animal %></h5>
    </div>

  <% if @invoice.open? %>
    <div class="col-sm-6 pt-3">
        <p>Adoption Fees Due <span id="amtDue"><%= number_to_currency(@invoice.amount) %></span></p>
        <p><%= @invoice.description %></p>
        <%= form_for @invoice do |f| %>
          <%= render 'shared/error_messages', :object => f.object %>
          <div class="form-group">
              <%= f.label :donation, '(Optional) Include a donation with your payment' %>
              <%= f.number_field :donation, class: "form-control" %>
          </div>
          <%= hidden_field_tag(:stripeToken) %>
        <% end %>
        <button id="payButton" class="btn btn-primary btn-lg">Make Payment</button>

  <% else %>
        <p>Invoice of <%= number_to_currency(@invoice.amount) %> was paid in full <%= @invoice.paid_at.strftime("%m/%d/%Y at %l:%M:%S %p") %>.
      <% end %>
    </div>
  </div>
</div>


<script src="https://checkout.stripe.com/checkout.js"></script>

<script>
  var handler = StripeCheckout.configure({
    key: '<%= Rails.configuration.stripe[:publishable_key] %>',
    locale: 'auto',
    name: 'Operation Paws for Homes',
    description: 'Adoption Fee',
    panelLabel: 'Pay {{amount}}',
    email: '<%= @invoice.invoiceable.adopter.email %>',
    zipCode: true,
    image: '/apple-touch-icon.png',

    token: function(token) {
      $('input#stripeToken').val(token.id);
      $('form').submit();
    }
  });

  $('#payButton').on('click', function(e) {
    e.preventDefault();

    $('#error_explanation').html('');

    var donation = document.getElementById("invoice_donation").value;

    donation = donation.replace(/\$/g, '').replace(/\,/g, '');

    if(isNaN(donation)) {
      donation = 0
    }
    // set to 0 if negative
    donation = Math.max(0,donation);

    donation = parseFloat(donation);
    donation = donation * 100; // Needs to be an integer!
    console.log('donation amount is '+ donation)


    var feesDue = document.getElementById("amtDue").innerText;
    feesDue = feesDue.replace(/\$/g, '').replace(/\,/g, '');
    feesDue = parseFloat(feesDue);
    feesDue = feesDue * 100; // Needs to be an integer!

    console.log('fee amount is '+ feesDue)

    var amount = donation + feesDue
    handler.open({
      amount: Math.round(amount),
    })
  });

    // Close Checkout on page navigation
  $(window).on('popstate', function() {
    handler.close();
  });
</script>
